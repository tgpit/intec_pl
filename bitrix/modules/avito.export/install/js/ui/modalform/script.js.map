{"version":3,"file":"script.js","sources":["../../plugin/skeleton.js","../../plugin/utils.js","src/index.js"],"sourcesContent":["import {compileTemplate} from \"./utils\";\r\n\r\n// noinspection JSUnresolvedVariable\r\nconst $ = window.AvitoJQuery ?? window.$;\r\n\r\nexport class Skeleton {\r\n\r\n\tstatic defaults = {\r\n\t\tlang: {},\r\n\t\tlangPrefix: null\r\n\t};\r\n\r\n\tconstructor(element: HTMLElement, options: Object = {}) {\r\n\t\tthis.$el = $(element);\r\n\t\tthis.el = this.$el[0];\r\n\t\tthis.options = Object.assign({}, this.constructor.defaults, this.$el.data(), options);\r\n\t}\r\n\r\n\tdestroy() {\r\n\t\tthis.el = null;\r\n\t}\r\n\t\r\n\tgetElement(key, context, method) : JQuery {\r\n\t\tconst selector = this.getElementSelector(key);\r\n\t\r\n\t\treturn this.getNode(selector, context, method || 'find');\r\n\t}\r\n\t\r\n\tgetElementSelector(key: string) : string {\r\n\t\tconst optionKey = key + 'Element';\r\n\t\r\n\t\treturn this.options[optionKey];\r\n\t}\r\n\t\r\n\tgetTemplate(key: string) : string {\r\n\t\tconst optionKey = key + 'Template';\r\n\t\tconst option = this.options[optionKey];\r\n\t\tconst optionFirstSymbol = option.substring(0, 1);\r\n\t\tlet result;\r\n\t\r\n\t\tif (optionFirstSymbol === '.' || optionFirstSymbol === '#') {\r\n\t\t\tresult = this.getNode(option).html();\r\n\t\t} else {\r\n\t\t\tresult = option;\r\n\t\t}\r\n\t\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tgetNode(selector, context, method = 'find') : JQuery {\r\n\t\tif (selector.substring(0, 1) === '#') { // is id query\r\n\t\t\tcontext = $(document);\r\n\t\t} else if (!context) {\r\n\t\t\tcontext = this.$el;\r\n\t\t}\r\n\t\r\n\t\treturn context[method](selector);\r\n\t}\r\n\t\r\n\tgetLang(key, replaces) : string {\r\n\t\tlet langKey;\r\n\t\tlet result;\r\n\t\r\n\t\tif (this.options.lang != null && key in this.options.lang) {\r\n\t\t\tresult = this.options.lang[key];\r\n\t\t} else {\r\n\t\t\tlangKey = this.options.langPrefix + key;\r\n\t\t\tresult = BX.message(langKey) || '';\r\n\t\t}\r\n\t\r\n\t\tif (result && replaces) {\r\n\t\t\tresult = compileTemplate(result, replaces);\r\n\t\t}\r\n\t\r\n\t\treturn result;\r\n\t}\r\n}\r\n","// @flow\r\n\r\nexport function compileTemplate(template: string, replaces: Object) {\r\n\tlet result = template;\r\n\r\n\tfor (const key in replaces) {\r\n\t\tif (!replaces.hasOwnProperty(key)) { continue; }\r\n\r\n\t\tconst replaceKey = '#' + key + '#';\r\n\t\tconst replaceValue = replaces[key];\r\n\r\n\t\tdo {\r\n\t\t\tresult = result.replace(replaceKey, replaceValue);\r\n\t\t} while (result.indexOf(replaceKey) !== -1);\r\n\t}\r\n\r\n\treturn result;\r\n}\r\n\r\nexport function htmlToElement(html, tag = 'div') {\r\n\tconst renderer = document.createElement(tag);\r\n\r\n\trenderer.innerHTML = html;\r\n\r\n\treturn renderer.firstElementChild;\r\n}","// noinspection JSUnresolvedReference\r\n\r\nimport {Skeleton} from \"../../../plugin/skeleton\";\r\n\r\n// noinspection JSUnusedGlobalSymbols\r\nexport class ModalForm extends Skeleton {\r\n\r\n\tstatic defaults = {\r\n\t\turl: null,\r\n\t\tdata: null,\r\n\t\ttitle: null,\r\n\t\tsaveTitle: null,\r\n\t\twidth: 400,\r\n\t\theight: 250,\r\n\t\tbuttons: null,\r\n\t}\r\n\r\n\t_modal;\r\n\t_handled = {};\r\n\t_activateDeferred;\r\n\r\n\thandleFormSubmit(dir: boolean) : void {\r\n\t\tthis.wrapHandle('formSubmit', dir, () => {\r\n\t\t\tconst contentElement = this._modal.GetContent();\r\n\r\n\t\t\t$(contentElement)[dir ? 'on' : 'off']('submit', this.onFormSubmit);\r\n\t\t});\r\n\t}\r\n\r\n\thandleFormSave(dir: boolean) : void {\r\n\t\tthis.wrapHandle('formSave', dir, () => {\r\n\t\t\tBX[dir ? 'addCustomEvent' : 'removeCustomEvent']('avitoExportFormSave', this.onFormSave);\r\n\t\t});\r\n\t}\r\n\r\n\thandleError(dir: boolean) : void {\r\n\t\tthis.wrapHandle('error', dir, () => {\r\n\t\t\tBX[dir ? 'addCustomEvent' : 'removeCustomEvent'](this._modal, 'onWindowError', this.onError);\r\n\t\t});\r\n\t}\r\n\r\n\thandleClose(dir: boolean) : void {\r\n\t\tthis.wrapHandle('close', dir, () => {\r\n\t\t\tBX[dir ? 'addCustomEvent' : 'removeCustomEvent'](this._modal, 'onWindowClose', this.onClose);\r\n\t\t});\r\n\t}\r\n\r\n\twrapHandle(type: string, dir: boolean, callback: () => {}) : void {\r\n\t\tif (!!this._handled[type] === dir) { return; }\r\n\r\n\t\tif (this._modal != null) {\r\n\t\t\tcallback(dir);\r\n\t\t\tthis._handled[type] = dir;\r\n\t\t} else if (!dir) {\r\n\t\t\tthis._handled[type] = false;\r\n\t\t}\r\n\t}\r\n\r\n\tonFormSubmit = () : void => {\r\n\t\tconst node = this.getModal().GetForm();\r\n\t\tconst form = $(node);\r\n\r\n\t\tthis.prepareAjaxForm(form);\r\n\t}\r\n\r\n\tonFormSave = (data) : void => {\r\n\t\tthis.activateEnd(data);\r\n\t\tthis._modal.Close();\r\n\t\tBX.closeWait();\r\n\t}\r\n\r\n\tonError = () : void => {\r\n\t\tthis._modal?.closeWait();\r\n\t}\r\n\r\n\tonClose = () : void => {\r\n\t\tthis.handleFormSubmit(false);\r\n\t\tthis.handleFormSave(false);\r\n\t\tthis.handleError(false);\r\n\t\tthis.handleClose(false);\r\n\r\n\t\tthis.activateStop();\r\n\t}\r\n\r\n\tactivate() : void {\r\n\t\tthis._modal ??= this.createModal();\r\n\r\n\t\tthis._modal.Show();\r\n\r\n\t\tthis.handleFormSubmit(true);\r\n\t\tthis.handleFormSave(true);\r\n\t\tthis.handleError(true);\r\n\t\tthis.handleClose(true);\r\n\r\n\t\tif (this._activateDeferred != null) {\r\n\t\t\tthis._activateDeferred.reject();\r\n\t\t}\r\n\r\n\t\treturn (this._activateDeferred = new $.Deferred());\r\n\t}\r\n\r\n\tactivateStop() : void {\r\n\t\tthis._activateDeferred?.reject();\r\n\t\tthis._activateDeferred = null;\r\n\t}\r\n\r\n\tactivateEnd(data) : void {\r\n\t\tthis._activateDeferred?.resolve(data);\r\n\t\tthis._activateDeferred = null;\r\n\t}\r\n\r\n\tgetModal(): Object {\r\n\t\tif (this._modal == null) {\r\n\t\t\tthis._modal = this.createModal();\r\n\t\t}\r\n\r\n\t\treturn this._modal;\r\n\t}\r\n\r\n\tcreateModal() : BX.CAdminDialog {\r\n\t\tconst options = this.getModalOptions();\r\n\r\n\t\treturn new BX.CAdminDialog(options);\r\n\t}\r\n\r\n\tgetModalOptions() : Object {\r\n\t\treturn {\r\n\t\t\ttitle: this.options.title,\r\n\t\t\twidth: this.options.width,\r\n\t\t\theight: this.options.height,\r\n\t\t\tcontent_url: this.makeModalUrl(),\r\n\t\t\tcontent_post: this.options.data,\r\n\t\t\tdraggable: true,\r\n\t\t\tresizable: true,\r\n\t\t\tbuttons: this.getModalButtons(),\r\n\t\t};\r\n\t}\r\n\r\n\tgetModalButtons() : Array {\r\n\t\treturn this.options.buttons != null ? this.options.buttons : this.getDefaultButtons();\r\n\t}\r\n\r\n\tgetDefaultButtons() : Array {\r\n\t\tlet saveBtn = BX.CAdminDialog.btnSave;\r\n\r\n\t\tif (this.options.saveTitle) {\r\n\t\t\tsaveBtn = Object.assign({}, saveBtn, {\r\n\t\t\t\ttitle: this.options.saveTitle,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\treturn [\r\n\t\t\tsaveBtn,\r\n\t\t\tBX.CAdminDialog.btnCancel,\r\n\t\t];\r\n\t}\r\n\r\n\tmakeModalUrl() : string {\r\n\t\tconst url = this.options.url || '';\r\n\r\n\t\treturn url\r\n\t\t\t+ (url.indexOf('?') === -1 ? '?' : '&')\r\n\t\t\t+ 'view=dialog';\r\n\t}\r\n\r\n\tprepareAjaxForm(form: $) : void {\r\n\t\tif (form.find('input[name=\"ajaxForm\"]').length > 0) { return; }\r\n\r\n\t\tform.append('<input type=\"hidden\" name=\"ajaxForm\" value=\"Y\" />');\r\n\t}\r\n\r\n}"],"names":["$","window","AvitoJQuery","Skeleton","constructor","element","options","$el","el","this","Object","assign","defaults","data","destroy","getElement","key","context","method","selector","getElementSelector","getNode","optionKey","getTemplate","option","optionFirstSymbol","substring","result","html","document","getLang","replaces","langKey","lang","langPrefix","BX","message","template","hasOwnProperty","replaceKey","replaceValue","replace","indexOf","compileTemplate","ModalForm","_handled","onFormSubmit","node","getModal","GetForm","form","prepareAjaxForm","onFormSave","activateEnd","_modal","Close","closeWait","onError","onClose","handleFormSubmit","handleFormSave","handleError","handleClose","activateStop","dir","wrapHandle","contentElement","GetContent","type","callback","activate","createModal","Show","_activateDeferred","reject","Deferred","resolve","getModalOptions","CAdminDialog","title","width","height","content_url","makeModalUrl","content_post","draggable","resizable","buttons","getModalButtons","getDefaultButtons","saveBtn","btnSave","saveTitle","btnCancel","url","find","length","append"],"mappings":"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"}