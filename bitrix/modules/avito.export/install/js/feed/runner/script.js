this.BX=this.BX||{},this.BX.AvitoExport=this.BX.AvitoExport||{},function(t){"use strict";function e(t,e){let s=t;for(const t in e){if(!e.hasOwnProperty(t))continue;const r="#"+t+"#",i=e[t];do{s=s.replace(r,i)}while(-1!==s.indexOf(r))}return s}var s;const r=null!=(s=window.AvitoJQuery)?s:window.$;class i{constructor(t,e={}){this.$el=r(t),this.el=this.$el[0],this.options=Object.assign({},this.constructor.defaults,this.$el.data(),e)}destroy(){this.el=null}getElement(t,e,s){const r=this.getElementSelector(t);return this.getNode(r,e,s||"find")}getElementSelector(t){const e=t+"Element";return this.options[e]}getTemplate(t){const e=t+"Template",s=this.options[e],r=s.substring(0,1);let i;return i="."===r||"#"===r?this.getNode(s).html():s,i}getNode(t,e,s="find"){return"#"===t.substring(0,1)?e=r(document):e||(e=this.$el),e[s](t)}getLang(t,s){let r,i;return null!=this.options.lang&&t in this.options.lang?i=this.options.lang[t]:(r=this.options.langPrefix+t,i=BX.message(r)||""),i&&s&&(i=e(i,s)),i}}i.defaults={lang:{},langPrefix:null};class n extends Error{constructor(t,e){super(t),this.response=e}}class o extends Error{constructor(t,e){super(t.message),this.response=e,this.previousError=t}}var a;const l=null!=(a=window.AvitoJQuery)?a:window.$;class h extends i{constructor(t,s={}){super(t,s),this.onRunClick=t=>{this.toggleButtons(!0),this.showMessage(),this.startTimer(),this.query("run"),t.preventDefault()},this.onStopClick=t=>{this.query("stop"),t.preventDefault()},this.onCopyClick=t=>{t.preventDefault();const e=t.currentTarget.previousElementSibling.value;navigator.clipboard.writeText(e).then((()=>{this.showMessageCopyLink(this.getLang("LINK_COPIED")+" "+e)})).catch((t=>{throw console.log(t),t}))},this.tickTimer=()=>{const t=this._timerStart,e=this.getElement("timer"),s=(new Date-t)/1e3;let r=""+parseInt(s%60,10),i=""+Math.floor(s/60);1===i.length&&(i="0"+i),1===r.length&&(r="0"+r),e.text(i+":"+r),this._timerInterval=setTimeout(this.tickTimer,1e3)},this.queryEnd=t=>{const e=this.parseResponse(t);if(this._query=null,this.showMessage(e.message),"progress"===e.status)this.queryDelayed("run",this.getFormValue("TIME_SLEEP")),this.setState(e.state);else"ok"===e.status&&this.bindCopy(),this.clearFormData(),this.clearState(),this.stopTimer(),this.toggleButtons(!1)},this.queryStop=(t,e,s)=>{if(this._query=null,"manual"!==(null!=e?e:t.statusText)){if(200!==t.status)throw new n(`HTTP ${t.status}`,t.responseText);throw new n(s||e,t.responseText)}},this.queryError=t=>{const s=this.getTemplate("error");let r;r=t instanceof o?{TITLE:this.getLang("PARSE_ERROR"),MESSAGE:t.previousError.message,DEBUG:BX.util.htmlspecialchars(t.response)}:t instanceof n?{TITLE:this.getLang("HTTP_ERROR"),MESSAGE:t.message,DEBUG:BX.util.htmlspecialchars(t.response)}:t instanceof Error?{TITLE:this.getLang("JS_ERROR"),MESSAGE:t.message,DEBUG:BX.util.htmlspecialchars(t.trace)}:{TITLE:"Unknown error",MESSAGE:t,DEBUG:""},this.stopTimer(),this.toggleButtons(!1),this.clearFormData(),this.clearState(),this.showMessage(e(s,r))},this.bind(),this.initVars()}initVars(){this._formData=null,this._query=null,this._queryTimeout=null,this._state=null,this._timerInterval=null}bind(){this.handleRunClick(!0),this.handleStopClick(!0)}bindCopy(){this.handleCopyClick(!0)}unbind(){this.handleRunClick(!1),this.handleStopClick(!1)}handleRunClick(t){this.getElement("run")[t?"on":"off"]("click",this.onRunClick)}handleStopClick(t){this.getElement("stop")[t?"on":"off"]("click",this.onStopClick)}handleCopyClick(t){this.getElement("copy")[t?"on":"off"]("click",this.onCopyClick)}showMessageCopyLink(t=""){alert(t)}query(t){this.queryDelayedCancel(),this.queryAbort(),this._query=this.makeQuery(t),new Promise(((t,e)=>{this._query.then(t,e)})).then(this.queryEnd,this.queryStop).catch(this.queryError)}getFormData(){return null===this._formData&&(this._formData=this.$el.serializeArray()),this._formData.slice()}clearFormData(){this._formData=null}getState(){return this._state}getFormValue(t){const e=this.getFormData();let s=[];for(let r=e.length-1;r>=0;r--)if(e[r].name===t){s=e[r].value;break}return s}setState(t){this._state=t}clearState(){this._state=null}makeQuery(t){const e=this.getState();let s={url:this.$el.attr("action"),type:"post",data:this.getFormData()};if(s.data.push({name:"action",value:t}),null!==e)for(let t in e)e.hasOwnProperty(t)&&s.data.push({name:t,value:e[t]});return l.ajax(s)}showMessage(t=""){this.getElement("message").html(t||"")}startTimer(){const t=this.getElement("timer");this.getElement("timerHolder").show(),t.text("00:00"),clearTimeout(this._timerInterval),this._timerStart=new Date,this._timerInterval=setTimeout(this.tickTimer,1e3)}stopTimer(){clearTimeout(this._timerInterval)}queryAbort(){null!=this._query&&this._query.abort("manual")}queryDelayed(t,e){this.queryDelayedCancel(),this._queryTimeout=setTimeout(l.proxy(this.query,this,t),1e3*(parseInt(e,10)||1))}queryDelayedCancel(){clearTimeout(this._queryTimeout)}parseResponse(t){try{const e="string"==typeof t?JSON.parse(t):t;if(!l.isPlainObject(e))throw new Error("not valid response");return e}catch(e){throw new o(e,"string"!=typeof t?JSON.stringify(t):t)}}toggleButtons(t){const e=this.getElement("run"),s=this.getElement("stop");e.prop("disabled",t),s.prop("disabled",!t)}}h.defaults={runElement:".js-export-form__run",stopElement:".js-export-form__stop",copyElement:".js-export-copy_to_clipboard",linkFileElement:".js-link-file",messageElement:".js-export-form__message",timerHolderElement:".js-export-form__timer-holder",timerElement:".js-export-form__timer",errorTemplate:"<span>#TITLE#</span> <span>#MESSAGE#</span> <textarea>#DEBUG#</textarea>",lang:{COPY_TO_BUFFER:"The link is copied to the clipboard: ",JS_ERROR:"JavaScript error",HTTP_ERROR:"HTTP error",PARSE_ERROR:"Response parse error"}},t.Runner=h}(this.BX.AvitoExport.Feed=this.BX.AvitoExport.Feed||{});
//# sourceMappingURL=script.js.map
