this.BX=this.BX||{},this.BX.AvitoExport=this.BX.AvitoExport||{},this.BX.AvitoExport.Admin=this.BX.AvitoExport.Admin||{},this.BX.AvitoExport.Admin.Property=this.BX.AvitoExport.Admin.Property||{},function(t){"use strict";class e{constructor(t){this.component=t,this._middleware=[]}middleware(t){this._middleware.push(t)}fetch(t,e={}){return new Promise(((s,i)=>{BX.ajax.runComponentAction(this.component,t,{mode:"ajax",data:this.prepare(t,e)}).then((t=>{const e=t.data;"ok"===e.status?s(e.data):"error"===e.status?i(new Error(e.message)):i(new Error("unknown response format"))})).catch((t=>{i(this.queryError(t))}))}))}prepare(t,e){for(const s of this._middleware)e=s(t,e);return e}queryError(t){if("error"!==t.status)return new Error("unknown response");if(!Array.isArray(t.errors)||0===t.errors.length)return new Error("error response does not contain errors");const e=t.errors[t.errors.length-1];return new Error(e.message)}}function s(t,e){let s=t;if(null==e)return s;for(const[t,i]of Object.entries(e)){const e="#"+t+"#";let n=-1,r=-1;do{n=r,s=s.replace(e,i),r=s.indexOf(e)}while(-1!==r&&r>n)}return s}function i(t,e="div"){const s=document.createElement(e);return s.innerHTML=t,s.firstElementChild}class n{constructor(t,e={}){this.el=t,this.options=Object.assign({},this.constructor.defaults,e),this._stateHolder=null}loading(){this.state("loading")}waiting(){this.state("waiting")}error(t){this.state("error",{MESSAGE:t.message})}state(t,e={}){const s=this.compileTemplate(t,e),i=this.stateHolder(t);this.markTypeClass(i,t),this.replaceHtml(i,s)}compileTemplate(t,e={}){let i;return i=s(this.options[t+"Template"],e),i=s(i,this.options.lang),i}markTypeClass(t,e){const s=["loading","waiting","error"];for(const i of s)i===e?t.classList.add(i):t.classList.remove(i)}replaceHtml(t,e){t.innerHTML=e}stateHolder(){if(null!=this._stateHolder)return this._stateHolder;const t=i(this.options.stateTemplate);return this.el.after(t),this._stateHolder=t,this._stateHolder}}n.defaults={stateTemplate:'<span class="bx-avito-export-characteristic__state"></span>',loadingTemplate:"#LOADING#...",waitingTemplate:"",errorTemplate:"#MESSAGE#",lang:{LOADING:"Loading"}};class r{constructor(t,e,s={}){this.onFocus=()=>{this.load()},this.onChange=()=>{this.hasVariants()&&(this.normalize(),this.item.refresh())},this.item=t,this.el=e,this.options=Object.assign({},this.constructor.defaults,s),this._stored=null,this._variants=null,this._state=this.options.state,this.bind()}bind(){this.handleInput(!0)}unbind(){this.handleInput(!1)}handleInput(t,e=null){this.handleFocus(t,e),this.handleChange(t,e)}handleFocus(t,e=null){var s;null==e&&(e=this.input()),null==(s=e)||s[t?"addEventListener":"removeEventListener"]("focus",this.onFocus)}handleChange(t,e=null){var s;null==e&&(e=this.input()),null==(s=e)||s[t?"addEventListener":"removeEventListener"]("change",this.onChange)}load(){var t;const e=this.values();return this.isChanged(e)?(this.store(e),this.clear(),null==(t=this._state)||t.loading(),this.query(e).then((t=>{var e;this.render(t),null==(e=this._state)||e.waiting()})).catch((t=>{var e;null==(e=this._state)||e.error(t),this.release()}))):Promise.resolve()}isChanged(t){if(null==this._stored)return!0;let e=!1;for(const s of Object.keys(t)){const i=t[s],n=this._stored[s];if(!this.compare(i,n)){e=!0;break}}return e}store(t){this._stored=t}release(){this._stored=null}query(t){return this.transport().fetch("variants",{attribute:this.options.attribute,values:t})}transport(){const t=this.options.transport;if(!(t instanceof e))throw new Error("transport must be instance of Transport");return t}clear(){var t;const e=this.input();"select"===(null==e||null==(t=e.tagName)?void 0:t.toLowerCase())&&e.querySelectorAll("option").forEach((t=>{t.selected||t.remove()}))}redraw(t){this.store(this.values()),this.render(t)}render(t){const e=this.input(),s=t.length>0?"select":"input",n="select"===s?this.selectHtml(t):this.inputHtml(),r=this.options[s+"Element"],o=null==e?void 0:e.value;let l;null==e?(l=i(n),this.el.insertAdjacentElement("beforeend",l)):l=e.matches(r)?this.redrawControl(e,n):this.replaceControl(e,n),this.setInputValue(l,o),this._variants=t}selectHtml(t){return s(this.options.selectTemplate,{OPTIONS:t.map((t=>`<option>${BX.util.htmlspecialchars(t)}</option>`)).join("")})}inputHtml(){return this.options.inputTemplate}input(){var t;return null!=(t=this.el.querySelector(this.options.selectElement))?t:this.el.querySelector(this.options.inputElement)}selected(){var t;return null==(t=this.input())?void 0:t.value}redrawControl(t,e){const s=i(e).innerHTML.trim();return""===s||(t.innerHTML=s),t}setInputValue(t,e){"select"===t.tagName.toLowerCase()?t.querySelectorAll("option").forEach((t=>{t.selected=t.value===e})):t.value=null!=e?e:""}replaceControl(t,e){const s=i(e);return s.name=t.name,s.className=t.className,this.handleInput(!1,t),t.after(s),t.remove(),this.handleInput(!0,s),s}normalize(){const t=this.el.value,e=this.matched(t);this.el.value=null!=e?e:""}hasVariants(){return null!=this._variants&&this._variants.length>0}matched(t){if(null==this._variants)return;let e;for(const s of this._variants)if(this.compare(t,s)){e=s;break}return e}compare(t,e){return(null!=t?t:"").trim().toLowerCase()===(null!=e?e:"").trim().toLowerCase()}values(){const t=this.options.values;return"function"==typeof t?t():t}}r.defaults={transport:null,state:null,attribute:null,selectElement:"select",selectTemplate:"<select>#OPTIONS#</select>",inputElement:"input",inputTemplate:'<input type="text" autocomplete="off" />',values:{}};class o{constructor(t,e,s={}){this.onDeleteClick=()=>{this.field.delete(this)},this.field=t,this.el=e,this.options=Object.assign({},this.constructor.defaults,s),this.resolveAttribute(),this.bootSuggest(),this.bind()}destroy(){this.unbind(),this.options=null,this.el=null}bind(){this.handleDeleteClick(!0)}unbind(){this.handleDeleteClick(!1)}handleDeleteClick(t){const e=this.el.querySelector(this.options.deleteElement);null==e||e[t?"addEventListener":"removeEventListener"]("click",this.onDeleteClick)}resolveAttribute(){if(null!=this.options.attribute)return;const t=this.el.querySelector(this.options.attributeElement);this.options.attribute=(t instanceof HTMLInputElement?t.value:t.textContent).trim()}bootSuggest(){const t=this.el.querySelector(this.options.valueElement);this.suggest=new r(this,t,{transport:this.options.transport,state:this.options.state,attribute:this.options.attribute,values:()=>this.collectValues()})}autoload(){this.load()}load(){return this.suggest.load()}collectValues(){return this.field.values(this)}attribute(){return this.options.attribute}redraw(t){this.suggest.redraw(t)}value(){return this.suggest.selected()}refresh(){this.field.refresh(this)}allowDelete(){const t=this.el.querySelector(this.options.deleteElement);null!==t&&(t.disabled=!1)}disableDelete(){const t=this.el.querySelector(this.options.deleteElement);null!==t&&(t.disabled=!0)}}o.defaults={transport:null,state:null,attribute:null,attributeElement:'[data-entity="attribute"]',valueElement:'[data-entity="value"]',deleteElement:'[data-entity="delete"]'};class l{constructor(t,e={}){this.el=t,this.options=Object.assign({},this.constructor.defaults,e),this._state=this.options.state,this._menu=null}suggest(t){var e;return null==(e=this._state)||e.loading(),this.disableButton(),this.query(t).then((t=>this.render(t))).then((()=>{var t;this.enableButton(),null==(t=this._state)||t.waiting()})).catch((t=>{var e;this.enableButton(),null==(e=this._state)||e.error(t)}))}query(t){return this.transport().fetch("attributes",{values:t})}transport(){const t=this.options.transport;if(!(t instanceof e))throw new Error("transport must be instance of Transport");return t}render(t){if(0===t.length)throw new Error(this.options.lang.ERROR_ATTRIBUTE);const e=this.menu(),s=this.menuItems(t);e.setItems(s),e.Show()}select(t){this.options.onChoose(t)}menu(){return null==this._menu&&(this._menu=new BX.CMenu({parent:this.el})),this._menu}menuItems(t){const e=[];for(const s of t)e.push({TEXT:s,ONCLICK:()=>{this.select(s)}});return e}disableButton(){this.el.disabled=!0}enableButton(){this.el.disabled=!1}}l.defaults={transport:null,state:null,lang:{ERROR_ATTRIBUTE:"No next attributes"},onChoose:()=>{}};class a{constructor(t,e={}){this.el=t,this.options=Object.assign({},this.constructor.defaults,e)}values(t,e){throw new Error("not implemented")}form(){const t=this.el.closest("form");if(null==t)throw new Error("cant find form");return t}formInput(t,e){return t.querySelector(`[name^="${e}"]`)}inputValue(t,e){var s;return null==(s=this.formInput(t,e))?void 0:s.value}selectValue(t,e){const s=this.formInput(t,e);if(null==s)return null;const i=[];for(const t of s.querySelectorAll("option"))t.selected&&i.push(t.value);return i}}class u extends a{values(t,e){const s=this.form();return{value:this.inputValue(s,this.options.name)}}}u.defaults={name:null};class h extends a{values(t,e){var s,i;const n=this.form();return{iblockSectionId:null!=(s=this.inputValue(n,this.options.primaryName))?s:0,iblockSection:null!=(i=this.selectValue(n,this.options.selectName))?i:[],iblockId:this.options.iblockId,property:this.options.property}}}h.defaults={primaryName:null,selectName:null,iblockId:null,property:null};class c extends a{values(t,e){const s=this.form();return{sku:this.inputValue(s,this.options.skuName),skuIblockId:this.options.skuIblockId,property:this.options.property}}}c.defaults={skuName:null,skuIblockId:null,property:null};class d extends a{values(t,e){const s=this.form();return{sku:this.inputValue(s,this.options.skuName),skuIblockId:this.options.skuIblockId,property:this.options.property}}}d.defaults={skuName:null,skuIblockId:null,property:null};class p extends a{values(t,e){const s=this.form();return{value:this.inputValue(s,this.options.name)}}}p.defaults={name:null};class m{static make(t,e,s){if("element"===t)return new u(e,s);if("section"===t)return new h(e,s);if("productElement"===t)return new c(e,s);if("productSection"===t)return new d(e,s);if("massiveEdit"===t)return new p(e,s);throw new Error("unknown form category type")}}class f{constructor(t,s={}){this.onAddClick=t=>{const e=this.values();this.attributes(t.target).suggest(e)},this.transportCategory=(t,e)=>{const s=[];for(const i of this.options.categoryOptions){const n=m.make(i.type,this.el,i),r=Object.assign({},{type:i.type},n.values(t,e));s.push(r)}return Object.assign({},e,{category:s})},this.el=t,this.options=Object.assign({},this.constructor.defaults,this.nodeOptions(),s),this._attributes=null,this._newIndex=0,this._transport=new e(this.options.component),this._transport.middleware(this.transportCategory),this._state=new n(this.addButton(),{lang:this.options.lang}),this.boot(),this.bind()}nodeOptions(){const t={};for(const e in this.el.dataset){if(!this.el.dataset.hasOwnProperty(e))continue;let s=this.el.dataset[e];"true"===s?s=!0:"false"===s?s=!1:0!==s.indexOf("{")&&0!==s.indexOf("[")||(s=JSON.parse(s)),t[e]=s}return t}destroy(){this.unbind()}bind(){this.handleAddClick(!0)}unbind(){this.handleAddClick(!1)}handleAddClick(t){const e=this.addButton();null!=e&&e.matches(this.options.addElement)&&e[t?"addEventListener":"removeEventListener"]("click",this.onAddClick)}boot(){const t=this.el.querySelectorAll(this.options.itemElement),e=[];for(const s of t)e.push(new o(this,s,this.itemDefaults()));this.items=e}attributes(t){return null!=this._attributes||(this._attributes=new l(t,{transport:this._transport,state:this._state,lang:this.options.lang,onChoose:t=>this.add(t)})),this._attributes}add(t){this.createItem(t).autoload(),this.reflowDelete()}createItem(t){const e="n"+ ++this._newIndex,n=i(s(this.options.itemTemplate,this.itemVariables(t,e)),"table"),r=new o(this,n,Object.assign({},this.itemDefaults(),{attribute:t}));return this.el.insertAdjacentElement("beforeend",n),this.items.push(r),r}itemVariables(t,e){var s;return{DELETE_TITLE:null!=(s=this.options.lang.DELETE)?s:""}}itemDefaults(){return{transport:this._transport,state:this._state,lang:this.options.lang}}deleteOnChange(t){let e=this.items.indexOf(t);return this.delete(t),e--}delete(t){var e;this.destroyItem(t),this.reflowDelete(),null==(e=this._state)||e.waiting()}destroyItem(t){const e=this.items.indexOf(t);if(-1===e)throw new Error("unknown item");t.el.remove(),t.destroy(),this.items.splice(e,1)}reflowDelete(){const t=this.items.length;let e=0;for(const s of this.items)e===t-1?s.allowDelete():s.disableDelete(),++e}values(t=null){const e={};for(const s of this.items){if(t===s)break;e[s.attribute()]=s.value()}return e}addButton(){return this.el.nextElementSibling}refresh(t){this._transport.fetch("refresh",{values:this.values(),from:t.attribute()}).then((e=>{let s=!1,i=new Map(this.items.map(((t,e)=>[e,t])));for(let[r,o]of i){if(o===t){s=!0;continue}if(!s)continue;const i=o.attribute();var n;if(void 0===e[i])r=this.deleteOnChange(o);else o.redraw(null!=(n=e[i])&&n)}})).catch((t=>{this._state.error(t)}))}}f.defaults={component:null,categoryOptions:[],lang:{},valueName:null,attributeName:null,itemElement:"tr",itemTemplate:'<tr><td class="bx-avito-export-characteristic__label"><input type="hidden" name="#ATTRIBUTE_NAME#" value="#ATTRIBUTE_VALUE#" data-entity="attribute" />#ATTRIBUTE_VALUE#</td><td class="bx-avito-export-characteristic__value" data-entity="value"><select class="bx-avito-export-characteristic__value-control" name="#VALUE_NAME#"></select></td><td class="bx-avito-export-characteristic__actions"><button class="bx-avito-export-characteristic__delete" type="button" data-entity="delete">#DELETE_TITLE#</button></td></tr>',addElement:'input[type="button"]'};class b extends f{itemVariables(t,e){return Object.assign({},super.itemVariables(t),{ATTRIBUTE_NAME:`${this.options.attributeName}[${e}][DESCRIPTION]`,ATTRIBUTE_VALUE:t,VALUE_NAME:`${this.options.valueName}[${e}][VALUE]`})}}b.defaults=Object.assign({},f.defaults,{itemTemplate:'<tr><td class="bx-avito-export-characteristic__label"><input type="hidden" name="#ATTRIBUTE_NAME#" value="#ATTRIBUTE_VALUE#" data-entity="attribute" />#ATTRIBUTE_VALUE#</td><td class="bx-avito-export-characteristic__value" data-entity="value"><select class="bx-avito-export-characteristic__value-control" name="#VALUE_NAME#"></select></td><td class="bx-avito-export-characteristic__actions"><button class="bx-avito-export-characteristic__delete" type="button" data-entity="delete">#DELETE_TITLE#</button></td></tr>'});class v extends f{itemVariables(t,e){return Object.assign({},super.itemVariables(t),{ATTRIBUTE_VALUE:t,VALUE_NAME:`${this.options.valueName}[${t}]`})}}v.defaults=Object.assign({},f.defaults,{itemTemplate:'<tr><td class="bx-avito-export-characteristic__label" data-entity="attribute">#ATTRIBUTE_VALUE#</td><td class="bx-avito-export-characteristic__value" data-entity="value"><select class="bx-avito-export-characteristic__value-control" name="#VALUE_NAME#"></select></td><td class="bx-avito-export-characteristic__actions"><button class="bx-avito-export-characteristic__delete" type="button" data-entity="delete">#DELETE_TITLE#</button></td></tr>'}),t.MultipleField=b,t.SingleField=v}(this.BX.AvitoExport.Admin.Property.Characteristic=this.BX.AvitoExport.Admin.Property.Characteristic||{});
//# sourceMappingURL=script.js.map
