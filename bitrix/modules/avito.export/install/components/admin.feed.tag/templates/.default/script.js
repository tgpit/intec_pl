this.BX=this.BX||{},this.BX.AvitoExport=this.BX.AvitoExport||{},function(t){"use strict";var e;const s=null!=(e=window.AvitoJQuery)?e:window.$;class i{constructor(t,e={}){this.$el=s(t),this.el=this.$el[0],this.options=Object.assign({},this.constructor.defaults,this.$el.data(),e)}destroy(){this.el=null}getElement(t,e,s){const i=this.getElementSelector(t);return this.getNode(i,e,s||"find")}getElementSelector(t){const e=t+"Element";return this.options[e]}getTemplate(t){const e=t+"Template",s=this.options[e],i=s.substring(0,1);let o;return o="."===i||"#"===i?this.getNode(s).html():s,o}getNode(t,e,i="find"){return"#"===t.substring(0,1)?e=s(document):e||(e=this.$el),e[i](t)}getLang(t,e){let s,i;return null!=this.options.lang&&t in this.options.lang?i=this.options.lang[t]:(s=this.options.langPrefix+t,i=BX.message(s)||""),i&&e&&(i=function(t,e){let s=t;for(const t in e){if(!e.hasOwnProperty(t))continue;const i="#"+t+"#",o=e[t];do{s=s.replace(i,o)}while(-1!==s.indexOf(i))}return s}(i,e)),i}}i.defaults={lang:{},langPrefix:null};class o extends i{constructor(t,e={}){super(t,e),this.onClick=()=>{this.open()},this._menu=null,this.bind()}destroy(){this.unbind(),super.destroy()}bind(){this.handleClick(!0)}unbind(){this.handleClick(!1)}handleClick(t){this.$el[t?"on":"off"]("click",this.onClick)}open(){const t=this.menu(),e=this.items();t.setItems(e),!t.visible()&&t.Show()}menu(){return null==this._menu&&(this._menu=new BX.CMenu({parent:this.el,ATTACH_MODE:"right"})),this._menu}items(){const t=[];for(const e of this.options.rows())t.push({TEXT:e.name(),ONCLICK:()=>this.options.onSelect(e)});return t}}var n;o.defaults={rows:()=>[],onSelect:()=>{}};const l=null!=(n=window.AvitoJQuery)?n:window.$;class a extends i{constructor(t,e={}){super(t,e),this.onOpenClick=()=>{this.open()},this.onSaveClick=()=>{this.save(),this.dialog().Close()},this.onCloseClick=()=>{this.dialog().Close()},this.onDialogClose=()=>{const t=this.dialog();this.destroyDialog(),this.handleCloseClick(t,!1)},this.bind()}destroy(){this.unbind()}bind(){this.handleOpenClick(!0)}unbind(){this.handleOpenClick(!1),this.handleCloseClick(!1)}handleOpenClick(t){this.$el[t?"on":"off"]("click",this.onOpenClick)}handleCloseClick(t){(t||this.hasDialog())&&BX[t?"addCustomEvent":"removeCustomEvent"](this.dialog(),"onWindowClose",this.onDialogClose)}open(){this.openDialog(),this.bootEditor(),this.bootTaskbar(),this.bootInjection(),this.hideTaskbarSwitcher()}openDialog(){const t=this.dialog(),e=this.getTemplate("dialog");t.SetContent(e),t.Show(),this.handleCloseClick(!0)}destroyDialog(){this.dialogContent().html("")}bootEditor(){const t=this.dialogContent(),e=this.getElement("editor",t),s=this.initialValue(),i=this.editorTemplateHtml();e.attr("id","bx-html-editor-"+this.options.visualEditorId),e.html(i),this.editorInitialValue(s)}editorTemplateHtml(){return this.getTemplate("editor").replace(/<\\\/script>/g,"<\/script>")}editorInitialValue(t){var e;const s=this.visualEditor();if(null!=s&&null!=(e=s.sandbox)&&e.inited)s.SetContent(t,!0);else{const e=()=>{s.SetContent(t,!0),BX.removeCustomEvent(s,"OnCreateIframeAfter",e)};BX.addCustomEvent(s,"OnCreateIframeAfter",e)}}bootTaskbar(){const t=this.visualEditor();null==t.taskbarManager&&(t.taskbarManager=new BXHtmlEditor.TaskbarManager(t,!0),t.dom.taskbarCont.style.display="",t.showTaskbars=!0)}bootInjection(){const t=this.sources(),e=this.visualEditor(),s=class extends BXHtmlEditor.Taskbar{constructor(t,e,s){super(t),this.id="avito_injection",this.title=s.VISUAL_EDITOR_INJECTION_TITLE,this.templateId=this.editor.templateId,this.uniqueId="taskbar_"+this.editor.id+"_"+this.id,this.searchPlaceholder=s.VISUAL_EDITOR_INJECTION_SEARCH,this.avitoSources=e,this.Init()}Init(){const[t,e]=this.treeParams();this.BuildSceleton(),this.BuildTree(t,e)}HandleElementEx(t,e,s){this.editor.SetBxTag(e,{tag:"php_protected",params:s})}treeParams(){const t=[],e=[];for(const s of this.avitoSources){t.push({name:s.TITLE,path:"",title:s.TITLE});for(const t of s.ITEMS)e.push({value:this.isSourceField(t.ID)?"{="+t.ID+"}":t.ID,path:s.TITLE,title:t.VALUE})}return[t,e]}isSourceField(t){return/^[A-Z0-9_]+\.[A-Z0-9_]+/.test(t)}},i=new s(e,t,this.options.lang);e.taskbarManager.AddTaskbar(i),e.taskbarManager.ShowTaskbar(i.GetId()),e.taskbarManager.Show(!1)}initialValue(){const t=this.options.value;return"function"==typeof t?t():t}hideTaskbarSwitcher(){this.visualEditor().taskbarManager.pTopCont.style.display="none"}save(){const t=this.visualEditor().GetContent(),e=-1!==t.indexOf("{=")?"TEMPLATE":"TEXT";this.options.onSave(t,e)}hasDialog(){return null!=this._dialog}dialog(){return null==this._dialog&&(this._dialog=this.createDialog()),this._dialog}dialogContent(){const t=this.dialog();return l(t.PARTS.CONTENT_DATA)}createDialog(){return new BX.CAdminDialog({title:this.getLang("VISUAL_EDITOR_MODAL_TITLE",{TAG:this.options.tagName}),draggable:!0,resizable:!0,width:this.options.width,height:this.options.height,buttons:[Object.assign({},BX.CAdminDialog.btnSave,{action:this.onSaveClick}),Object.assign({},BX.CAdminDialog.btnCancel,{action:this.onCloseClick})]})}sources(){const t=this.options.sources;return"function"==typeof t?t():t}visualEditor(){return BXHtmlEditor.Get(this.options.visualEditorId)}}var r;a.defaults={value:"",sources:[],dialogWidth:800,dialogHeight:600,dialogTemplate:'<div data-entity="editor"></div>',editorElement:'[data-entity="editor"]',editorTemplate:"#avito-editor-template",visualEditorId:"avitoeditor",lang:{},onSave:t=>{}};const h=null!=(r=window.AvitoJQuery)?r:window.$;class d extends i{constructor(...t){super(...t),this.onDeleteClick=()=>{this.options.onDelete(this)},this.onValueChange=()=>{this.resolveFormat()}}clone(){const t=this.$el.clone(!1,!1),e=new d(t,this.options);return e.clearClone(),e}destroy(){this.unbind(),super.destroy()}bind(){this.handleDeleteClick(!0),this.handleValueChange(!0)}unbind(){this.handleDeleteClick(!1),this.handleValueChange(!1)}handleDeleteClick(t){this.getElement("delete")[t?"on":"off"]("click",this.onDeleteClick)}handleValueChange(t){this.getElement("value")[t?"on":"off"]("change",this.onValueChange)}isActive(){return!this.$el.hasClass("avito--hidden")}isMultiple(){return!1!==this.options.multiple}isRequired(){return!1!==this.options.required}activate(t=!1){!t&&this.isActive()||(this.$el.removeClass("avito--hidden"),this.bind(),this.bootValue(),this.bootTemplate(),this.bootHint(),this.enableControls(!0))}deactivate(t=!1){(t||this.isActive())&&(this.destroyValue(),this.destroyTemplate(),this.unbind(),this.enableControls(!1),this.$el.addClass("avito--hidden"))}name(){return this.getElement("name").text()}reset(){for(const t of this.controls())t.is("input, select")&&"hidden"!==t.prop("type")&&(t.is("select")?t.find("option").prop("selected",!1):-1!==["radio","checkbox"].indexOf(t.prop("type"))?t.prop("checked",!1):t.val(""))}focus(){for(const t of this.controls())if(t.is("input, select")&&"hidden"!==t.prop("type")){t.focus();break}}allowDelete(t){const e=this.getElement("delete");e.prop("disabled",!t),e.toggleClass("avito--hidden",!t)}enableControls(t){for(const e of this.controls())e.prop("disabled",!t)}updateControlName(t){for(const e of this.controls()){const s=e.attr("name"),i=null!=s?/\[\w+]$/.exec(s):null;if(null==i)continue;const o=t+i[0];e.attr("name",o)}}controls(){return[this.getElement("code"),this.getElement("tag"),this.getElement("value"),this.getElement("format")]}bootHint(){this.getElement("hint").each(((t,e)=>{BX.hint_replace(e,e.getAttribute("data-hint"))}))}bootValue(){const t=this.getElement("value");t.is("select")&&(t.select2({tags:!0,selectOnClose:!0,placeholder:this.getLang("VALUE_PLACEHOLDER"),insertTag:(t,e)=>{t.push(e)}}),t.on("select2:open",(()=>{setTimeout((()=>{const t=h(".select2-container--open .select2-search__field").last().get(0);null==t||t.focus()}),100)})))}destroyValue(){const t=this.getElement("value");t.is("select")&&(t.select2("destroy"),t.off("select2:open"))}bootTemplate(){const t=this.getElement("template");0!==t.length&&(this._templateEditor=new a(t,{sources:()=>this.templateSources(),value:()=>{const t=this.getElement("value").find("option").filter(":selected").get(0);if(null==t)return"";const e=null==t?void 0:t.getAttribute("value");return null==e?t.textContent:e.length>0?"{="+e+"}":""},tagName:this.getElement("name").text(),lang:this.options.lang,onSave:(t,e)=>this.saveTemplate(t,e)}))}templateSources(){const t=this.getElement("value").find("optgroup"),e=[];for(let s=0;s<t.length;s++){const i=h(t[s]),o=i.find("option"),n=[];for(let t=0;t<o.length;t++){const e=h(o[t]);n.push({ID:e.val(),VALUE:e.text()})}e.push({TITLE:i.attr("label"),ITEMS:n})}return e}saveTemplate(t,e){this.saveTemplateValue(t,e),this.setFormat(e)}saveTemplateValue(t,e){const s=this.getElement("value"),i=document.createElement("option");i.textContent=t,i.setAttribute("data-format",e),s.append(i),i.selected=!0}destroyTemplate(){null!=this._templateEditor&&(this._templateEditor.destroy(),this._templateEditor=null)}resolveFormat(){const t=this.getElement("value").find("option").filter(":selected"),e=t.data("format");let s;s=null!=e?e:null!=t.attr("value")?"FIELD":"TEXT",this.setFormat(s)}setFormat(t){this.getElement("format").each(((e,s)=>{s.checked=s.value===t}))}clearClone(){const t=this.getElement("value"),e=t.next();t.hasClass("select2-hidden-accessible")&&(t.removeClass("select2-hidden-accessible").removeAttr("data-select2-id").removeAttr("aria-hidden").removeAttr("tabindex"),t.find("optgroup").removeAttr("data-select2-id"),t.find("option").removeAttr("data-select2-id")),e.hasClass("select2")&&e.remove()}}d.defaults={hintElement:'[data-entity="hint"]',codeElement:'[data-entity="code"]',nameElement:'[data-entity="name"]',tagElement:'[data-entity="tag"]',valueElement:'[data-entity="value"]',formatElement:'[data-entity="format"]',templateElement:'[data-entity="template"]',deleteElement:'[data-entity="delete"]',required:!1,multiple:!1,onDelete:()=>{},lang:{}};class c extends i{constructor(t,e={}){super(t,e),this.rowsForAdd=()=>{const t=[],e=[];for(const s of this.rows()){const i=s.name();s.isActive()&&!s.isMultiple()||-1===e.indexOf(i)&&(t.push(s),e.push(i))}return t},this._nextIndex=this.options.nextIndex,this.bootRows(),this.bootAddButton()}bootRows(){const t=this.getElement("row"),e=[];t.each(((t,s)=>{const i=new d(s,{onDelete:t=>this.delete(t),lang:this.options.lang});i.isActive()&&i.activate(!0),e.push(i)})),this._rows=e}bootAddButton(){const t=this.getElement("addButton");this.addButton=new o(t,{rows:this.rowsForAdd,onSelect:t=>this.add(t)})}add(t){if(t.isActive()){if(!t.isMultiple())throw new Error("cant add few rows for non-multiple row");this.insertRow(t),this.reflowDelete(t.name())}else this.activateRow(t)}activateRow(t){const e=this._nextIndex++,s=this.options.baseName+`[${e}]`;t.updateControlName(s),t.reset(),t.activate(),t.focus()}insertRow(t){const e=this.typeRows(t.name()),s=e.length>0?e[e.length-1]:t,i=s.clone(),o=this._nextIndex++,n=this.options.baseName+`[${o}]`;i.updateControlName(n),i.$el.insertAfter(s.$el),i.reset(),i.activate(!0),i.focus(),this._rows.push(i)}delete(t){const e=t.name();if(this.typeRows(e,!0).length>1)this.removeRow(t),this.reflowDelete(e);else{if(t.isRequired())throw new Error("cant remove last required row");t.deactivate()}}removeRow(t){const e=t.$el,s=this._rows.indexOf(t);if(-1===s)throw new Error("cant delete unknown row");t.destroy(),e.remove(),this._rows.splice(s,1)}reflowDelete(t){const e=this.typeRows(t,!0),s=e.length>1;for(const t of e)t.allowDelete(s||!t.isRequired())}rows(t=!1){if(!t)return this._rows;const e=[];for(const t of this._rows)t.isActive()&&e.push(t);return e}typeRows(t,e=!1){const s=[];for(const i of this._rows)e&&!i.isActive()||i.name()===t&&s.push(i);return s}}c.defaults={baseName:null,nextIndex:0,rowElement:'[data-entity="row"]',addButtonElement:'[data-entity="addButton"]'},t.Tags=c}(this.BX.AvitoExport.Feed=this.BX.AvitoExport.Feed||{});
//# sourceMappingURL=script.js.map
