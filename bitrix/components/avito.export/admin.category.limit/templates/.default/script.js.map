{"version":3,"file":"script.js","sources":["../../../../js/plugin/skeleton.js","../../../../js/plugin/utils.js","src/row.js","src/index.js"],"sourcesContent":["import {compileTemplate} from \"./utils\";\n\n// noinspection JSUnresolvedVariable\nconst $ = window.AvitoJQuery ?? window.$;\n\nexport class Skeleton {\n\n\tstatic defaults = {\n\t\tlang: {},\n\t\tlangPrefix: null\n\t};\n\n\tconstructor(element: HTMLElement, options: Object = {}) {\n\t\tthis.$el = $(element);\n\t\tthis.el = this.$el[0];\n\t\tthis.options = Object.assign({}, this.constructor.defaults, this.$el.data(), options);\n\t}\n\n\tdestroy() {\n\t\tthis.el = null;\n\t}\n\t\n\tgetElement(key, context, method) : JQuery {\n\t\tconst selector = this.getElementSelector(key);\n\t\n\t\treturn this.getNode(selector, context, method || 'find');\n\t}\n\t\n\tgetElementSelector(key: string) : string {\n\t\tconst optionKey = key + 'Element';\n\t\n\t\treturn this.options[optionKey];\n\t}\n\t\n\tgetTemplate(key: string) : string {\n\t\tconst optionKey = key + 'Template';\n\t\tconst option = this.options[optionKey];\n\t\tconst optionFirstSymbol = option.substring(0, 1);\n\t\tlet result;\n\t\n\t\tif (optionFirstSymbol === '.' || optionFirstSymbol === '#') {\n\t\t\tresult = this.getNode(option).html();\n\t\t} else {\n\t\t\tresult = option;\n\t\t}\n\t\n\t\treturn result;\n\t}\n\t\n\tgetNode(selector, context, method = 'find') : JQuery {\n\t\tif (selector.substring(0, 1) === '#') { // is id query\n\t\t\tcontext = $(document);\n\t\t} else if (!context) {\n\t\t\tcontext = this.$el;\n\t\t}\n\t\n\t\treturn context[method](selector);\n\t}\n\t\n\tgetLang(key, replaces) : string {\n\t\tlet langKey;\n\t\tlet result;\n\t\n\t\tif (this.options.lang != null && key in this.options.lang) {\n\t\t\tresult = this.options.lang[key];\n\t\t} else {\n\t\t\tlangKey = this.options.langPrefix + key;\n\t\t\tresult = BX.message(langKey) || '';\n\t\t}\n\t\n\t\tif (result && replaces) {\n\t\t\tresult = compileTemplate(result, replaces);\n\t\t}\n\t\n\t\treturn result;\n\t}\n}\n","// @flow\n\nexport function compileTemplate(template: string, replaces: Object) {\n\tlet result = template;\n\n\tfor (const key in replaces) {\n\t\tif (!replaces.hasOwnProperty(key)) { continue; }\n\n\t\tconst replaceKey = '#' + key + '#';\n\t\tconst replaceValue = replaces[key];\n\n\t\tdo {\n\t\t\tresult = result.replace(replaceKey, replaceValue);\n\t\t} while (result.indexOf(replaceKey) !== -1);\n\t}\n\n\treturn result;\n}\n\nexport function htmlToElement(html, tag = 'div') {\n\tconst renderer = document.createElement(tag);\n\n\trenderer.innerHTML = html;\n\n\treturn renderer.firstElementChild;\n}","// @flow\n\nimport {Skeleton} from \"../../../../../js/plugin/skeleton\";\n\nexport class Row extends Skeleton {\n\n\tstatic defaults = {\n\t\tcategoryElement: '[data-entity=\"category\"]',\n\t\tlimitElement: '[data-entity=\"limit\"]',\n\t\tdeleteElement: '[data-entity=\"delete\"]',\n\n\t\tonDelete: () => {},\n\n\t\tlang: {},\n\t}\n\n\tconstructor(element: HTMLElement, options: Object = {}) {\n\t\tsuper(element, options);\n\t\tthis.bind();\n\t}\n\n\tclone() : Row {\n\t\tconst element = this.$el.clone(false, false);\n\t\tconst result = new Row(element, this.options);\n\n\t\tresult.clearClone();\n\n\t\treturn result;\n\t}\n\n\tdestroy() : void {\n\t\tthis.destroyCategory();\n\t\tthis.unbind();\n\n\t\tsuper.destroy();\n\t}\n\n\tdestroyCategory() {\n\t\tthis._category.destroy();\n\t}\n\n\tboot() : void {\n\t\tthis.bootCategory();\n\t}\n\n\tbootCategory() {\n\t\tconst field = this.getElement('category');\n\n\t\tthis._category = new BX.AvitoExport.Admin.Property.Category(field, {\n\t\t\tcomponent: 'avito.export:admin.property.category',\n\t\t\tlanguage: 'ru',\n\t\t\tallowClear: false,\n\t\t\tlang: {\n\t\t\t\tVALUE_PLACEHOLDER: this.getLang('VALUE_PLACEHOLDER'),\n\t\t\t},\n\t\t});\n\t}\n\n\tbind() : void {\n\t\tthis.handleDeleteClick(true);\n\t}\n\n\tunbind() : void {\n\t\tthis.handleDeleteClick(false);\n\t}\n\n\thandleDeleteClick(dir: boolean) : void {\n\t\tconst element = this.getElement('delete');\n\n\t\telement[dir ? 'on' : 'off']('click', this.onDeleteClick);\n\t}\n\n\tonDeleteClick = () : void => {\n\t\tthis.options.onDelete(this);\n\t}\n\n\tupdateControlName(baseName: string) : void {\n\t\tfor (const control of this.controls()) {\n\t\t\tconst currentName = control.attr('name');\n\t\t\tconst nameLastMatches = currentName != null ? /\\[\\w+](\\[])?$/.exec(currentName) : null;\n\n\t\t\tif (nameLastMatches == null) { continue; }\n\n\t\t\tconst newName = baseName + nameLastMatches[0];\n\n\t\t\tcontrol.attr('name', newName);\n\t\t}\n\t}\n\n\tenableControls() : void {\n\t\tfor (const control of this.controls()) {\n\t\t\tcontrol.prop('disabled', false);\n\t\t}\n\t}\n\n\tdisableControls() : void {\n\t\tfor (const control of this.controls()) {\n\t\t\tcontrol.prop('disabled', true);\n\t\t}\n\t}\n\n\tcontrols() : Array {\n\t\treturn [\n\t\t\tthis.getElement('category'),\n\t\t\tthis.getElement('limit'),\n\t\t];\n\t}\n\n\tclear() {\n\t\tfor (const element of this.controls()) {\n\t\t\tif (element.is('select')) {\n\t\t\t\telement\n\t\t\t\t\t.find('option')\n\t\t\t\t\t.remove();\n\t\t\t} else {\n\t\t\t\telement.val('');\n\t\t\t}\n\t\t}\n\t}\n\n\tclearClone() : void {\n\t\tfor (const element of this.controls()) {\n\t\t\tif (!element.is('select')) { continue; }\n\n\t\t\tconst elementNext = element.next();\n\n\t\t\tif (element.hasClass('select2-hidden-accessible')) {\n\t\t\t\telement\n\t\t\t\t\t.removeClass('select2-hidden-accessible')\n\t\t\t\t\t.removeAttr('data-select2-id')\n\t\t\t\t\t.removeAttr('aria-hidden')\n\t\t\t\t\t.removeAttr('tabindex');\n\n\t\t\t\telement.find('optgroup')\n\t\t\t\t\t.removeAttr('data-select2-id');\n\n\t\t\t\telement.find('option')\n\t\t\t\t\t.removeAttr('data-select2-id');\n\t\t\t}\n\n\t\t\tif (elementNext.hasClass('select2')) {\n\t\t\t\telementNext.remove();\n\t\t\t}\n\t\t}\n\t}\n}","// @flow\n\nimport {Skeleton} from \"../../../../../js/plugin/skeleton\";\nimport {Row} from \"./row\";\n\n// noinspection JSUnusedGlobalSymbols\nexport class CategoryLimit extends Skeleton {\n\n\tstatic defaults = {\n\t\tcomponent: null,\n\t\tsignedParameters: null,\n\t\tbaseName: null,\n\t\tnextIndex: 0,\n\t\tnewRow: null,\n\t\trowElement: '[data-entity=\"row\"]',\n\t\taddButtonElement: '[data-entity=\"addButton\"]',\n\t}\n\n\t/** @var Row[] */\n\t_rows = [];\n\n\tconstructor(element: HTMLElement, options: Object = {}) {\n\t\tsuper(element, options);\n\n\t\tthis.bootRows();\n\t\tthis.bootAddButton();\n\t}\n\n\tbootRows() : void {\n\t\tconst elements = this.getElement('row');\n\t\tconst rows = [];\n\t\tlet previous = null;\n\n\t\telements.each((index, element) => {\n\t\t\tconst row = new Row(element, {\n\t\t\t\tonDelete: (row: Row) => this.delete(row),\n\t\t\t\tlang: this.options.lang,\n\t\t\t});\n\n\t\t\trow.boot();\n\n\t\t\trows.push(row);\n\t\t\tprevious = row;\n\t\t});\n\n\t\tthis._rows = rows;\n\t\tthis._nextIndex = rows.length;\n\t}\n\n\tdelete(row: Row) : void {\n\t\tif (this._rows.length > 1) {\n\t\t\tthis.removeRow(row);\n\t\t} else {\n\t\t\tthis.deactivateRow(row);\n\t\t}\n\t}\n\n\tremoveRow(row: Row) : void {\n\t\tconst rowElement = row.$el;\n\t\tconst rowIndex = this._rows.indexOf(row);\n\n\t\tif (rowIndex === -1) { throw new Error('cant delete unknown row'); }\n\n\t\trow.destroy();\n\t\trowElement.remove();\n\n\t\tthis._rows.splice(rowIndex, 1);\n\t}\n\n\tactivateRow(row: Row) : void {\n\t\trow.$el.removeClass('avito--hidden');\n\t\trow.enableControls();\n\t}\n\n\tdeactivateRow(row: Row) : void {\n\t\trow.$el.addClass('avito--hidden');\n\t\trow.disableControls();\n\t}\n\n\tbootAddButton() : void {\n\t\tconst element = this.getElement('addButton');\n\n\t\telement.on('click', () => this.add());\n\t}\n\n\tadd() : void {\n\t\tconst lastRow = this._rows[this._rows.length - 1];\n\n\t\tif (lastRow == null) {\n\t\t\tthrow new Error('at least row must be exists');\n\t\t}\n\n\t\tif (lastRow.$el.hasClass('avito--hidden')) {\n\t\t\tthis.activateRow(lastRow);\n\t\t} else {\n\t\t\tthis.insertRow(lastRow.clone(), lastRow.$el);\n\t\t}\n\t}\n\n\tinsertRow(row: Row, anchor: $) : void {\n\t\trow.$el.insertAfter(anchor);\n\t\trow.updateControlName(this.options.baseName + '[' + this._nextIndex + ']');\n\t\trow.clear();\n\t\trow.boot();\n\n\t\tthis._rows.push(row);\n\t\t++this._nextIndex;\n\t}\n}"],"names":["$","window","AvitoJQuery","Skeleton","constructor","element","options","$el","el","this","Object","assign","defaults","data","destroy","getElement","key","context","method","selector","getElementSelector","getNode","optionKey","getTemplate","option","optionFirstSymbol","substring","result","html","document","getLang","replaces","langKey","lang","langPrefix","BX","message","template","hasOwnProperty","replaceKey","replaceValue","replace","indexOf","compileTemplate","Row","onDeleteClick","onDelete","bind","clone","clearClone","destroyCategory","unbind","_category","boot","bootCategory","field","AvitoExport","Admin","Property","Category","component","language","allowClear","VALUE_PLACEHOLDER","handleDeleteClick","dir","updateControlName","baseName","control","controls","currentName","attr","nameLastMatches","exec","newName","enableControls","prop","disableControls","clear","is","find","remove","val","elementNext","next","hasClass","removeClass","removeAttr","categoryElement","limitElement","deleteElement","CategoryLimit","_rows","bootRows","bootAddButton","elements","rows","each","index","row","delete","push","_nextIndex","length","removeRow","deactivateRow","rowElement","rowIndex","Error","splice","activateRow","addClass","on","add","lastRow","insertRow","anchor","insertAfter","signedParameters","nextIndex","newRow","addButtonElement"],"mappings":"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"}