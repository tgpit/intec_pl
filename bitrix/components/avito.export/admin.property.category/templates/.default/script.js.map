{"version":3,"file":"script.js","sources":["../../../../js/plugin/skeleton.js","../../../../js/plugin/utils.js","src/transport.js","src/index.js"],"sourcesContent":["import {compileTemplate} from \"./utils\";\n\n// noinspection JSUnresolvedVariable\nconst $ = window.AvitoJQuery ?? window.$;\n\nexport class Skeleton {\n\n\tstatic defaults = {\n\t\tlang: {},\n\t\tlangPrefix: null\n\t};\n\n\tconstructor(element: HTMLElement, options: Object = {}) {\n\t\tthis.$el = $(element);\n\t\tthis.el = this.$el[0];\n\t\tthis.options = Object.assign({}, this.constructor.defaults, this.$el.data(), options);\n\t}\n\n\tdestroy() {\n\t\tthis.el = null;\n\t}\n\t\n\tgetElement(key, context, method) : JQuery {\n\t\tconst selector = this.getElementSelector(key);\n\t\n\t\treturn this.getNode(selector, context, method || 'find');\n\t}\n\t\n\tgetElementSelector(key: string) : string {\n\t\tconst optionKey = key + 'Element';\n\t\n\t\treturn this.options[optionKey];\n\t}\n\t\n\tgetTemplate(key: string) : string {\n\t\tconst optionKey = key + 'Template';\n\t\tconst option = this.options[optionKey];\n\t\tconst optionFirstSymbol = option.substring(0, 1);\n\t\tlet result;\n\t\n\t\tif (optionFirstSymbol === '.' || optionFirstSymbol === '#') {\n\t\t\tresult = this.getNode(option).html();\n\t\t} else {\n\t\t\tresult = option;\n\t\t}\n\t\n\t\treturn result;\n\t}\n\t\n\tgetNode(selector, context, method = 'find') : JQuery {\n\t\tif (selector.substring(0, 1) === '#') { // is id query\n\t\t\tcontext = $(document);\n\t\t} else if (!context) {\n\t\t\tcontext = this.$el;\n\t\t}\n\t\n\t\treturn context[method](selector);\n\t}\n\t\n\tgetLang(key, replaces) : string {\n\t\tlet langKey;\n\t\tlet result;\n\t\n\t\tif (this.options.lang != null && key in this.options.lang) {\n\t\t\tresult = this.options.lang[key];\n\t\t} else {\n\t\t\tlangKey = this.options.langPrefix + key;\n\t\t\tresult = BX.message(langKey) || '';\n\t\t}\n\t\n\t\tif (result && replaces) {\n\t\t\tresult = compileTemplate(result, replaces);\n\t\t}\n\t\n\t\treturn result;\n\t}\n}\n","// @flow\n\nexport function compileTemplate(template: string, replaces: Object) {\n\tlet result = template;\n\n\tfor (const key in replaces) {\n\t\tif (!replaces.hasOwnProperty(key)) { continue; }\n\n\t\tconst replaceKey = '#' + key + '#';\n\t\tconst replaceValue = replaces[key];\n\n\t\tdo {\n\t\t\tresult = result.replace(replaceKey, replaceValue);\n\t\t} while (result.indexOf(replaceKey) !== -1);\n\t}\n\n\treturn result;\n}\n\nexport function htmlToElement(html, tag = 'div') {\n\tconst renderer = document.createElement(tag);\n\n\trenderer.innerHTML = html;\n\n\treturn renderer.firstElementChild;\n}","// @flow\n\nexport class Transport {\n\n\tconstructor(component: string) {\n\t\tthis.component = component;\n\t\tthis._middleware = [];\n\t}\n\n\tmiddleware(callback: () => {}) {\n\t\tthis._middleware.push(callback);\n\t}\n\n\tfetch(action: string, data: Object = {}) : Promise {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tBX.ajax.runComponentAction(this.component, action, {\n\t\t\t\tmode: 'ajax',\n\t\t\t\tdata: this.prepare(action, data),\n\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\tconst data = response.data;\n\n\t\t\t\t\tif (data.status === 'ok') {\n\t\t\t\t\t\tresolve(data.data);\n\t\t\t\t\t} else if (data.status === 'error') {\n\t\t\t\t\t\treject(new Error(data.message));\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(new Error('unknown response format'));\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((response) => { reject(this.queryError(response)); });\n\t\t});\n\t}\n\n\tprepare(action: string, data: Object) : Object {\n\t\tfor (const middleware of this._middleware) {\n\t\t\tdata = middleware(action, data);\n\t\t}\n\n\t\treturn data;\n\t}\n\n\t// noinspection DuplicatedCode\n\tqueryError(response: Object) : Error {\n\t\tif (response.status !== 'error') {\n\t\t\treturn new Error('unknown response');\n\t\t}\n\n\t\tif (!Array.isArray(response.errors) || response.errors.length === 0) {\n\t\t\treturn new Error('error response does not contain errors');\n\t\t}\n\n\t\tconst error = response.errors[response.errors.length - 1];\n\n\t\treturn new Error(error.message);\n\t}\n\n}","// @flow\n\nimport {Skeleton} from \"../../../../../js/plugin/skeleton\";\nimport {Transport} from \"./transport\";\n\n// noinspection JSUnresolvedVariable\nconst $ = window.AvitoJQuery ?? window.$;\n\n// noinspection JSUnusedGlobalSymbols\nexport class Category extends Skeleton {\n\n\tstatic defaults = {\n\t\tcomponent: null,\n\t\tlanguage: 'ru',\n\t\tallowClear: true,\n\t}\n\n\tconstructor(element: HTMLElement, options: Object = {}) {\n\t\tsuper(element, options);\n\t\tthis.options = Object.assign({}, this.constructor.defaults, options);\n\t\tthis.transport = new Transport(this.options.component);\n\n\t\tthis.bootSelect();\n\t\tthis.patchFocus();\n\t}\n\n\tbootSelect() {\n\t\tthis.$el.select2({\n\t\t\t//dropdownCssClass: 'increasedzindexclass', missing at minimal version of select2 (conflict with acrit.core)\n\t\t\tlanguage: this.options.language,\n\t\t\tminimumInputLength: 2,\n\t\t\tplaceholder: this.getLang('VALUE_PLACEHOLDER'),\n\t\t\tallowClear: this.options.allowClear,\n\t\t\tselectOnClose: true,\n\t\t\tajax: {\n\t\t\t\tcache: true,\n\t\t\t\tdelay: 250,\n\t\t\t\ttransport: this.ajaxTransport,\n\t\t\t},\n\t\t\ttemplateSelection: this.templateSelection,\n\t\t});\n\t}\n\n\tpatchFocus() {\n\t\tthis.$el.on('select2:open', () => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tconst search = $('.select2-container--open .select2-search__field').last().get(0);\n\t\t\t\tsearch?.focus();\n\t\t\t}, 100);\n\t\t});\n\t}\n\n\tajaxTransport = (params: Object, success: () => {}, failure: () => {}) : void => {\n\t\tthis.transport\n\t\t\t.fetch('suggest', {\n\t\t\t\tquery: params.data.q,\n\t\t\t})\n\t\t\t.then((options: Array) => this.convertOptions(options))\n\t\t\t.then((variants: Array) => { success(variants) })\n\t\t\t.catch((error) => { failure(error.message) });\n\t}\n\n\tconvertOptions(options: Array) : Object {\n\t\tconst variants = [];\n\n\t\tfor (const option of options) {\n\t\t\tvariants.push({\n\t\t\t\tid: option['ID'],\n\t\t\t\ttext: option['VALUE'],\n\t\t\t\tdisabled: option['DISABLED'],\n\t\t\t})\n\t\t}\n\n\t\treturn {\n\t\t\tresults: variants,\n\t\t}\n\t}\n\n\ttemplateSelection = (variant: Object) : string => {\n\t\treturn variant.id || variant.text;\n\t}\n}"],"names":["$","window","AvitoJQuery","Skeleton","constructor","element","options","$el","el","this","Object","assign","defaults","data","destroy","getElement","key","context","method","selector","getElementSelector","getNode","optionKey","getTemplate","option","optionFirstSymbol","substring","result","html","document","getLang","replaces","langKey","lang","langPrefix","BX","message","template","hasOwnProperty","replaceKey","replaceValue","replace","indexOf","compileTemplate","Transport","component","_middleware","middleware","callback","push","fetch","action","Promise","resolve","reject","ajax","runComponentAction","mode","prepare","then","response","status","Error","catch","queryError","Array","isArray","errors","length","error","Category","ajaxTransport","params","success","failure","transport","query","q","convertOptions","variants","templateSelection","variant","id","text","bootSelect","patchFocus","select2","language","minimumInputLength","placeholder","allowClear","selectOnClose","cache","delay","on","setTimeout","search","last","get","focus","disabled","results"],"mappings":"uJAGA,MAAMA,WAAIC,OAAOC,eAAeD,OAAOD,EAEhC,MAAMG,EAOZC,YAAYC,EAAsBC,EAAkB,SAC9CC,IAAMP,EAAEK,QACRG,GAAKC,KAAKF,IAAI,QACdD,QAAUI,OAAOC,OAAO,GAAIF,KAAKL,YAAYQ,SAAUH,KAAKF,IAAIM,OAAQP,GAG9EQ,eACMN,GAAK,KAGXO,WAAWC,EAAKC,EAASC,SAClBC,EAAWV,KAAKW,mBAAmBJ,UAElCP,KAAKY,QAAQF,EAAUF,EAASC,GAAU,QAGlDE,mBAAmBJ,SACZM,EAAYN,EAAM,iBAEjBP,KAAKH,QAAQgB,GAGrBC,YAAYP,SACLM,EAAYN,EAAM,WAClBQ,EAASf,KAAKH,QAAQgB,GACtBG,EAAoBD,EAAOE,UAAU,EAAG,OAC1CC,SAGHA,EADyB,MAAtBF,GAAmD,MAAtBA,EACvBhB,KAAKY,QAAQG,GAAQI,OAErBJ,EAGHG,EAGRN,QAAQF,EAAUF,EAASC,EAAS,cACF,MAA7BC,EAASO,UAAU,EAAG,GACzBT,EAAUjB,EAAE6B,UACDZ,IACXA,EAAUR,KAAKF,KAGTU,EAAQC,GAAQC,GAGxBW,QAAQd,EAAKe,OACRC,EACAL,SAEqB,MAArBlB,KAAKH,QAAQ2B,MAAgBjB,KAAOP,KAAKH,QAAQ2B,KACpDN,EAASlB,KAAKH,QAAQ2B,KAAKjB,IAE3BgB,EAAUvB,KAAKH,QAAQ4B,WAAalB,EACpCW,EAASQ,GAAGC,QAAQJ,IAAY,IAG7BL,GAAUI,IACbJ,ECrEI,SAAyBU,EAAkBN,OAC7CJ,EAASU,MAER,MAAMrB,KAAOe,EAAU,KACtBA,EAASO,eAAetB,kBAEvBuB,EAAa,IAAMvB,EAAM,IACzBwB,EAAeT,EAASf,MAG7BW,EAASA,EAAOc,QAAQF,EAAYC,UACI,IAAhCb,EAAOe,QAAQH,WAGlBZ,EDuDIgB,CAAgBhB,EAAQI,IAG3BJ,GArEIxB,EAELS,SAAW,CACjBqB,KAAM,GACNC,WAAY,YEPDU,EAEZxC,YAAYyC,QACNA,UAAYA,OACZC,YAAc,GAGpBC,WAAWC,QACLF,YAAYG,KAAKD,GAGvBE,MAAMC,EAAgBtC,EAAe,WAC7B,IAAIuC,SAAQ,CAACC,EAASC,KAC5BnB,GAAGoB,KAAKC,mBAAmB/C,KAAKoC,UAAWM,EAAQ,CAClDM,KAAM,OACN5C,KAAMJ,KAAKiD,QAAQP,EAAQtC,KAE1B8C,MAAMC,UACA/C,EAAO+C,EAAS/C,KAEF,OAAhBA,EAAKgD,OACRR,EAAQxC,EAAKA,MACa,UAAhBA,EAAKgD,OACfP,EAAO,IAAIQ,MAAMjD,EAAKuB,UAEtBkB,EAAO,IAAIQ,MAAM,+BAGlBC,OAAOH,IAAeN,EAAO7C,KAAKuD,WAAWJ,UAIjDF,QAAQP,EAAgBtC,OAClB,MAAMkC,KAActC,KAAKqC,YAC7BjC,EAAOkC,EAAWI,EAAQtC,UAGpBA,EAIRmD,WAAWJ,MACc,UAApBA,EAASC,cACL,IAAIC,MAAM,wBAGbG,MAAMC,QAAQN,EAASO,SAAsC,IAA3BP,EAASO,OAAOC,cAC/C,IAAIN,MAAM,gDAGZO,EAAQT,EAASO,OAAOP,EAASO,OAAOC,OAAS,UAEhD,IAAIN,MAAMO,EAAMjC,gBChDzB,MAAMpC,WAAIC,OAAOC,eAAeD,OAAOD,EAGhC,MAAMsE,UAAiBnE,EAQ7BC,YAAYC,EAAsBC,EAAkB,UAC7CD,EAASC,QAkChBiE,cAAgB,CAACC,EAAgBC,EAAmBC,UAC9CC,UACHzB,MAAM,UAAW,CACjB0B,MAAOJ,EAAO3D,KAAKgE,IAEnBlB,MAAMrD,GAAmBG,KAAKqE,eAAexE,KAC7CqD,MAAMoB,IAAsBN,EAAQM,MACpChB,OAAOM,IAAYK,EAAQL,EAAMjC,kBAmBpC4C,kBAAqBC,GACbA,EAAQC,IAAMD,EAAQE,UA5DxB7E,QAAUI,OAAOC,OAAO,GAAIF,KAAKL,YAAYQ,SAAUN,QACvDqE,UAAY,IAAI/B,EAAUnC,KAAKH,QAAQuC,gBAEvCuC,kBACAC,aAGND,kBACM7E,IAAI+E,QAAQ,CAEhBC,SAAU9E,KAAKH,QAAQiF,SACvBC,mBAAoB,EACpBC,YAAahF,KAAKqB,QAAQ,qBAC1B4D,WAAYjF,KAAKH,QAAQoF,WACzBC,eAAe,EACfpC,KAAM,CACLqC,OAAO,EACPC,MAAO,IACPlB,UAAWlE,KAAK8D,eAEjBS,kBAAmBvE,KAAKuE,oBAI1BK,kBACM9E,IAAIuF,GAAG,gBAAgB,KAC3BC,YAAW,WACJC,EAAShG,EAAE,mDAAmDiG,OAAOC,IAAI,SAC/EF,GAAAA,EAAQG,UACN,QAcLrB,eAAexE,SACRyE,EAAW,OAEZ,MAAMvD,KAAUlB,EACpByE,EAAS9B,KAAK,CACbiC,GAAI1D,EAAM,GACV2D,KAAM3D,EAAM,MACZ4E,SAAU5E,EAAM,iBAIX,CACN6E,QAAStB,IAjECT,EAEL1D,SAAW,CACjBiC,UAAW,KACX0C,SAAU,KACVG,YAAY"}