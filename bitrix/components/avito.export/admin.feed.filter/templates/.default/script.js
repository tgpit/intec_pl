this.BX=this.BX||{},this.BX.AvitoExport=this.BX.AvitoExport||{},function(t){"use strict";function e(t,e){let s=t;for(const t in e){if(!e.hasOwnProperty(t))continue;const i="#"+t+"#",n=e[t];do{s=s.replace(i,n)}while(-1!==s.indexOf(i))}return s}var s;const i=null!=(s=window.AvitoJQuery)?s:window.$;class n{constructor(t,e={}){this.$el=i(t),this.el=this.$el[0],this.options=Object.assign({},this.constructor.defaults,this.$el.data(),e)}destroy(){this.el=null}getElement(t,e,s){const i=this.getElementSelector(t);return this.getNode(i,e,s||"find")}getElementSelector(t){const e=t+"Element";return this.options[e]}getTemplate(t){const e=t+"Template",s=this.options[e],i=s.substring(0,1);let n;return n="."===i||"#"===i?this.getNode(s).html():s,n}getNode(t,e,s="find"){return"#"===t.substring(0,1)?e=i(document):e||(e=this.$el),e[s](t)}getLang(t,s){let i,n;return null!=this.options.lang&&t in this.options.lang?n=this.options.lang[t]:(i=this.options.langPrefix+t,n=BX.message(i)||""),n&&s&&(n=e(n,s)),n}}n.defaults={lang:{},langPrefix:null};class l{constructor(t,e){this.component=t,this.signedParameters=e}fetch(t,e={}){return new Promise(((s,i)=>{BX.ajax.runComponentAction(this.component,t,{mode:"ajax",signedParameters:this.signedParameters,data:e}).then((t=>{const e=t.data;"ok"===e.status?s(e.data):"error"===e.status?i(new Error(e.message)):i(new Error("unknown response format"))})).catch((t=>{i(this.queryError(t))}))}))}queryError(t){if("error"!==t.status)return new Error("unknown response");if(!Array.isArray(t.errors)||0===t.errors.length)return new Error("error response does not contain errors");const e=t.errors[t.errors.length-1];return new Error(e.message)}}var o;const r=null!=(o=window.AvitoJQuery)?o:window.$;class a{constructor(t){this.$el=r(t),this._field=null,this._multiple=!1}boot(){}destroy(){}type(){throw new Error("not implemented")}transport(t){this._transport=t}field(t,e){this._field=t,this._multiple=e}render(){const t=r(this.template()),e=this.findInput(t),s=this.findInput(this.$el),i=this.findAnchor(this.$el);e.attr("name",s.attr("name")),this.copyName(s,e),i.replaceWith(t),this.$el=e}findInput(t){const e='[data-entity="value"]';return t.is(e)?t:t.find(e).eq(0)}copyName(t,e){const s=t.attr("name").replace(/\[]$/,"");e.attr("name",s+(this._multiple?"[]":""))}findAnchor(t){const e=t.closest('[data-entity="valueAnchor"]');return e.length>0?e:t}reflow(){}template(){return""}}class h extends a{type(){return"select"}boot(){this.stampVariants(this.templateOptions()),this.$el.select2(this.selectOptions())}destroy(){this.$el.select2("destroy")}reflow(){const t=this.$el.prop("multiple")!==this._multiple,e=this.templateOptions();t&&(this.$el.select2("destroy"),this.$el.prop("multiple",this._multiple)),this.changedVariants(e)&&(this.stampVariants(e),this.$el.html(e)),t&&this.$el.select2(this.selectOptions())}selectOptions(){return{tokenSeparators:[","]}}template(){const t=this.templateOptions();return this.stampVariants(t),`<select class="adm-input-wrap adm-input-wrap-calendar" ${this._multiple?"multiple":""} data-entity="value">\n\t\t\t${t}\n\t\t</select>`}templateOptions(){return this._field.VARIANTS.map((t=>`<option value="${t.ID}">${t.VALUE}</option>`)).join("")}changedVariants(t){return this._renderedOptions!==t}stampVariants(t){this._renderedOptions=t}}class c extends a{constructor(...t){super(...t),this.onCalendarClick=t=>{BX.calendar({node:t.currentTarget,field:this.$el[0],form:"",bTime:!0,bHideTime:!0})}}type(){return"datetime"}boot(){this.handleCalendarClick(!0)}destroy(){this.handleCalendarClick(!1)}handleCalendarClick(t){this.$el.next(".adm-calendar-icon")[t?"on":"off"]("click",this.onCalendarClick)}template(){return'<div class="adm-input-wrap adm-input-wrap-calendar" data-entity="valueAnchor">\n\t\t\t<input class="adm-input adm-input-calendar" type="text" data-entity="value" />\n\t\t\t<span class="adm-calendar-icon"></span>\n\t\t</div>'}}class d extends a{type(){return"text"}boot(){this._multiple&&this.$el.select2(this.selectOptions())}selectOptions(){return{tags:!0,tokenSeparators:[","]}}destroy(){this._multiple&&this.$el.select2("destroy")}reflow(){const t=this.$el.is("select");t!==this._multiple&&(t&&this.$el.select2("destroy"),this.render(),this.boot())}template(){return this._multiple?'<select multiple data-entity="value"></select>':'<input type="text" data-entity="value" />'}}class u extends a{type(){return"autocomplete"}boot(){this.$el.select2(this.selectOptions())}destroy(){this.$el.select2("destroy")}reflow(){this.$el.prop("multiple")!==this._multiple&&(this.$el.select2("destroy"),this.$el.prop("multiple",this._multiple),this.$el.select2(this.selectOptions()))}template(){return`<select class="adm-input-wrap adm-input-wrap-calendar" ${this._multiple?"multiple":""} data-entity="value"></select>`}selectOptions(){return{minimumInputLength:1,ajax:{transport:this.ajaxTransport()}}}ajaxTransport(){return(t,e,s)=>{this._transport.fetch("suggest",{query:t.data.term,field:this._field.ID}).then((t=>this.convertOptions(t))).then(e).catch((t=>{s(t.message)}))}}convertOptions(t){const e=[];for(const s of t)e.push({id:s.ID,text:s.VALUE});return{results:e}}}var p;const m=null!=(p=window.AvitoJQuery)?p:window.$;class f extends n{constructor(t,e={}){super(t,e),this.onDeleteClick=()=>{this.options.onDelete(this)},this.onFieldChange=()=>{this.touchValue("field")&&(this.reflowCompare(),this.reflowValue())},this.onCompareChange=()=>{this.touchValue("compare")&&this.reflowValue()},this._stored={},this.touchValue("field"),this.touchValue("compare"),this.bind()}clone(){const t=this.$el.clone(!1,!1),e=new f(t,this.options);return e.clearClone(),e}destroy(){this.unbind(),this.destroyField(),super.destroy()}bind(){this.handleDeleteClick(!0),this.handleFieldChange(!0),this.handleCompareChange(!0)}unbind(){this.handleDeleteClick(!1),this.handleFieldChange(!1),this.handleCompareChange(!1)}handleDeleteClick(t){this.getElement("delete")[t?"on":"off"]("click",this.onDeleteClick)}handleFieldChange(t){this.getElement("field")[t?"on":"off"]("change keyup",this.onFieldChange)}handleCompareChange(t){this.getElement("compare")[t?"on":"off"]("change keyup",this.onCompareChange)}touchValue(t){const e=this.getElement(t).val();return this._stored[t]!==e&&(this._stored[t]=e,!0)}reflowCompare(){const t=this.selectedField(),e=this.getElement("compare").find("option");let s,i=!1;e.each(((e,n)=>{-1===t.CONDITIONS.indexOf(n.value)?(n.selected&&(i=!0),n.disabled=!0,n.selected=!1):(null==s&&(s=n),n.disabled=!1)})),i&&null!=s&&(s.selected=!0)}bootValue(){if(null!=this._valueUi)return;const t=this.selectedField(),e=this.isValueMultiple();this._valueUi=this.createValueUi(t,e),this._valueUi.boot()}reflowValue(){const t=this.selectedField(),e=this.isValueMultiple();null!=this._valueUi&&t.TEMPLATE===this._valueUi.type()?(this._valueUi.field(t,e),this._valueUi.reflow()):(null!=this._valueUi&&this._valueUi.destroy(),this._valueUi=this.createValueUi(t,e),this._valueUi.render(),this._valueUi.boot())}createValueUi(t,e){const s=this.getElement("value"),i=class{static make(t,e){return"autocomplete"===e?new u(t):"select"===e?new h(t):"datetime"===e?new c(t):new d(t)}}.make(s,t.TEMPLATE);return i.transport(this.options.transport),i.field(t,e),i}selectedField(){const t=this.getElement("field");return this.findFilter(t.val())}isValueMultiple(){const t=this.getElement("compare").find("option");let e=t.filter(":selected");return 0===e.length&&(e=t.filter(":disabled").eq(0)),null!=e.data("multiple")}findFilter(t){let e;for(const s of this.options.fields)if(s.ID===t){e=s;break}if(null==e)throw new Error("cant find filter for "+t);return e}reset(){this.resetField(),this.touchValue("field"),this.reflowCompare(),this.resetCompare(),this.touchValue("compare"),this.reflowValue()}resetField(){this.getElement("field").find("option").each(((t,e)=>{e.selected=!1}))}resetCompare(){this.getElement("compare").find("option").each(((t,e)=>{e.selected=!1}))}focus(){this.getElement("field").focus()}allowDelete(t){const e=this.getElement("delete");e.prop("disabled",!t),e.toggleClass("avito--hidden",!t)}updateControlName(t){for(const e of this.controls()){const s=e.attr("name"),i=null!=s?/\[\w+](\[])?$/.exec(s):null;if(null==i)continue;const n=t+i[0];e.attr("name",n)}}controls(){return[this.getElement("glue"),this.getElement("field"),this.getElement("compare"),this.getElement("value")]}boot(){this.bootField(),this.bootValue()}bootField(){const t=this.getElement("field");t.is("select")&&!t.hasClass("select2-hidden-accessible")&&(t.select2(),t.on("select2:open",(()=>{setTimeout((()=>{const t=m(".select2-container--open .select2-search__field").last().get(0);null==t||t.focus()}),100)})))}destroyField(){const t=this.getElement("field");t.is("select")&&t.hasClass("select2-hidden-accessible")&&(t.select2("destroy"),t.off("select2:open"))}clearClone(){const t=[this.getElement("field"),this.getElement("value")];for(const e of t){if(!e.is("select"))continue;const t=e.next();e.hasClass("select2-hidden-accessible")&&(e.removeClass("select2-hidden-accessible").removeAttr("data-select2-id").removeAttr("aria-hidden").removeAttr("tabindex"),e.find("optgroup").removeAttr("data-select2-id"),e.find("option").removeAttr("data-select2-id")),t.hasClass("select2")&&t.remove()}}setLevel(t){const e=1===t?0:1;this.$el.removeClass("level--"+e),this.$el.addClass("level--"+t)}setGlue(t){this.getElement("glue").val(t)}}f.defaults={fieldElement:'[data-entity="field"]',compareElement:'[data-entity="compare"]',valueElement:'[data-entity="value"]',deleteElement:'[data-entity="delete"]',glueElement:'[data-entity="glue"]',transport:null,fields:[],onDelete:()=>{},lang:{}};class g extends n{constructor(...t){super(...t),this.onClick=()=>{this.toggle()},this.bind()}destroy(){this.unbind()}setCollection(t){this.collection=t}setPrevious(t){this.previousRow=t}setNext(t){this.nextRow=t}bind(){this.handleClick(!0)}unbind(){this.handleClick(!1)}handleClick(t){this.$el[t?"on":"off"]("click",this.onClick)}isActive(){return this.$el.hasClass("is--active")}toggle(){this.isActive()?this.deactivate():this.activate()}activate(){this.isActive()||(this.previousRow.setLevel(1),this.nextRow.setLevel(1),this.nextRow.setGlue(g.GLUE_OR),this.renderState(1))}deactivate(){if(!this.isActive())return;const t=this.collection.previous(this),e=this.collection.next(this),s=null==t?void 0:t.isActive(),i=null==e?void 0:e.isActive();!s&&this.previousRow.setLevel(0),!i&&this.nextRow.setLevel(0),this.nextRow.setGlue(g.GLUE_AND),this.renderState(0)}renderState(t){const e=!!t;this.$el.text(e?this.getLang("JUNCTION_OR"):this.getLang("JUNCTION_AND")),this.$el.toggleClass("is--active",e)}}g.GLUE_AND="AND",g.GLUE_OR="OR",g.defaults={};class w{constructor(){this._collection=[]}add(t){this._collection.push(t),t.setCollection(this)}remove(t){const e=this.index(t);this._collection.splice(e,1)}previous(t){var e;const s=this.index(t)-1;return null!=(e=this._collection[s])?e:null}next(t){var e;const s=this.index(t)+1;return null!=(e=this._collection[s])?e:null}at(t){var e;return null!=(e=this._collection[t])?e:null}index(t){const e=this._collection.indexOf(t);if(-1===e)throw new Error("cant find junction at collection");return e}}class v extends n{constructor(t,e={}){super(t,e),this._rows=[],this._transport=new l(this.options.component,this.options.signedParameters),this.initRows()}initRows(){const t=this.getElement("row"),e=this.getElement("junction"),s=new w,i=[];let n=null;t.each(((t,l)=>{const o=new f(l,{transport:this._transport,onDelete:t=>this.delete(t),fields:this.options.fields,lang:this.options.lang});if(null!==n){const i=new g(e.eq(t-1),{lang:this.options.lang});i.setPrevious(n),i.setNext(o),s.add(i)}i.push(o),n=o})),this._rows=i,this._junctionCollection=s,this._nextIndex=i.length}boot(){this.bootRows(),this.bootAddButton(),this.bootDeleteButton()}bootRows(){for(const t of this._rows)t.boot()}bootAddButton(){this.getElement("addButton").on("click",(()=>this.add()))}bootDeleteButton(){this.getElement("deleteFilter").on("click",(()=>this.options.onDelete(this)))}add(){const t=this._rows[this._rows.length-1];if(null==t)throw new Error("at least one filter row must be exists");const e=t.clone();this.insertRow(e,t.$el),this.insertJunction(t,e),this.reflowDelete()}insertRow(t,e){t.$el.insertAfter(e),t.updateControlName(this.options.baseName+"["+this._nextIndex+"]"),t.reset(),t.boot(),this._rows.push(t),++this._nextIndex}insertJunction(t,s){var i;const n=e(this.getTemplate("junction"),{TEXT:this.getLang("JUNCTION_AND")}),l=new g(n,{lang:this.options.lang});l.$el.insertAfter(t.$el),l.setPrevious(t),l.setNext(s),this._junctionCollection.add(l),null!=(i=this._junctionCollection.previous(l))&&i.isActive()&&l.activate()}delete(t){this._rows.length>1?(this.removeJunction(t),this.removeRow(t),this.reflowDelete()):t.reset()}removeJunction(t){const e=this._rows.indexOf(t);let s;0===e?(s=this._junctionCollection.at(0),this.syncJunctionFirst(s)):(s=this._junctionCollection.at(e-1),this.syncJunctionBefore(s,this._rows[e-1])),s.destroy(),s.$el.remove(),this._junctionCollection.remove(s)}syncJunctionBefore(t,e){const s=this._junctionCollection.next(t);null!=s?(!t.isActive()&&s.isActive()&&s.deactivate(),s.setPrevious(e)):t.deactivate()}syncJunctionFirst(t){t.deactivate()}removeRow(t){const e=t.$el,s=this._rows.indexOf(t);if(-1===s)throw new Error("cant delete unknown row");t.destroy(),e.remove(),this._rows.splice(s,1)}reflowDelete(){const t=this._rows.length>1;for(const e of this._rows)e.allowDelete(t)}allowDelete(t){const e=this.getElement("deleteFilter");e.prop("disabled",!t),e.toggleClass("avito--hidden",!t)}reset(){const t=this._rows.slice();let e=0;for(const s of t)0===e?s.reset():this.delete(s),++e}clone(){const t=this.$el.clone(!1,!1),e=new v(t,this.options);return e.clearClone(),e}clearClone(){for(const t of this._rows)t.clearClone()}updateControlName(t){let e=0;this.options.baseName=t;for(const s of this._rows)s.updateControlName(`${t}[${e}]`),++e;this._nextIndex=this._rows.length}}v.defaults={component:null,signedParameters:null,baseName:null,nextIndex:0,fields:[],rowElement:'[data-entity="row"]',junctionElement:'[data-entity="junction"]',junctionTemplate:'<button class="avito-filter-junction" type="button" data-entity="junction">#TEXT#</button>',addButtonElement:'[data-entity="addButton"]',deleteFilterElement:'[data-entity="deleteFilter"]'};class _ extends n{constructor(t,e={}){super(t,e),this._filters=[],this.bootFilters(),this.bootAddButton()}bootFilters(){const t=this.getElement("filter"),e=[];t.each(((t,s)=>{const i=new v(s,{component:this.options.component,signedParameters:this.options.signedParameters,fields:this.options.fields,baseName:`${this.options.baseName}[${t}]`,lang:this.options.lang,onDelete:t=>this.delete(t)});i.boot(),e.push(i)})),this._filters=e,this._nextIndex=e.length}bootAddButton(){this.getElement("addFilter").on("click",(()=>this.add()))}add(){const t=this._filters[this._filters.length-1];if(null==t)throw new Error("at least one filter must be exists");const e=t.clone();this.insertFilter(e,t.$el),this.reflowDelete()}delete(t){this._filters.length<=1||(this.removeFilter(t),this.reflowDelete())}insertFilter(t,e){t.$el.insertAfter(e),t.updateControlName(this.options.baseName+"["+this._nextIndex+"]"),t.reset(),t.boot(),this._filters.push(t),++this._nextIndex}removeFilter(t){const e=t.$el,s=this._filters.indexOf(t);if(-1===s)throw new Error("cant delete unknown filter");t.destroy(),e.remove(),this._filters.splice(s,1)}reflowDelete(){const t=this._filters.length>1;for(const e of this._filters)e.allowDelete(t)}}_.defaults={filterElement:'[data-entity="filter"]',addFilterElement:'[data-entity="addFilter"]'},t.Filter=v,t.FilterCollection=_}(this.BX.AvitoExport.Feed=this.BX.AvitoExport.Feed||{});
//# sourceMappingURL=script.js.map
